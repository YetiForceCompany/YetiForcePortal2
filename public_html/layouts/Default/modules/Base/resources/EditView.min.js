'use strict';

/**
 * Base edit view class
 *
 * @copyright YetiForce S.A.
 * @license YetiForce Public License 5.0 (licenses/LicenseEN.txt or yetiforce.com)
 * @author Mariusz Krzaczkowski <m.krzaczkowski@yetiforce.com>
 */"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var descriptor,i=0;i<props.length;i++)descriptor=props[i],descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor);}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}window.Base_EditView_Js=/*#__PURE__*/function(){/**
	 * Constructor.
	 */function _class(){_classCallCheck(this,_class),this.container=void 0,this.form=void 0,this.moduleName=void 0;}/**
	 * Get container.
	 */return _createClass(_class,[{key:"getContainer",value:function getContainer(){return void 0===this.container&&(this.container=jQuery(".mainContent"),this.form=this.container.find("form"),this.moduleName=this.form.find("[name=\"module\"]").val()),this.container}/**
	 * Register reference events.
	 */},{key:"registerReferenceEvent",value:function registerReferenceEvent(){var _this=this;this.form.on("click",".js-add-reference",function(e){var element=$(e.currentTarget),moduleName=element.data("moduleName"),containerField=element.closest(".fieldValue"),formData=_this.form.serializeFormData();for(var i in formData)formData[i]&&-1==$.inArray(i,["_csrf","action","_fromView"])||delete formData[i];App.Components.QuickCreate.createRecord(moduleName,{data:{sourceRecordData:formData},callbackAfterSave:function callbackAfterSave(response){_this.setReferenceFieldValue(containerField,response);}});}),this.form.on("click",".js-clear-reference",function(e){_this.clearFieldValue($(e.currentTarget));}),this.form.on("click",".js-select-reference",function(e){var containerField=$(e.currentTarget).closest(".fieldValue"),url="index.php?module="+_this.getReferencedModuleName(containerField)+"&view=RecordListModal";app.getRecordList(url,function(e){_this.setReferenceFieldValue(containerField,{id:e.currentTarget.dataset.id,name:e.currentTarget.dataset.name});});}),this.form.find(".js-reference-list").on("change",function(e){var element=$(e.currentTarget),parentElem=element.closest(".fieldValue"),referenceModule=element.val(),referenceModuleElement=$(".js-reference-module",parentElem),prevSelectedReferenceModule=referenceModuleElement.val();referenceModuleElement.val(referenceModule),$(".js-quick-create",parentElem).data("moduleName",referenceModule),prevSelectedReferenceModule!=referenceModule&&parentElem.find(".js-clear-reference").trigger("click");});}/**
	 * Get referenced module name.
	 *
	 * @param {jQuery} parenElement
	 */},{key:"getReferencedModuleName",value:function getReferencedModuleName(parenElement){return $(".js-reference-module",parenElement).val()}/**
	 * Clear field value.
	 *
	 * @param {jQuery} element
	 */},{key:"clearFieldValue",value:function clearFieldValue(element){var fieldValueContender=element.closest(".fieldValue"),fieldNameElement=fieldValueContender.find(".sourceField"),fieldName=fieldNameElement.attr("name");fieldNameElement.val(""),fieldValueContender.find("input[data-display=\"".concat(fieldName,"\"]")).val("");}/**
	 * Set reference field value.
	 *
	 * @param {jQuery} fieldContainer
	 * @param {object} params
	 */},{key:"setReferenceFieldValue",value:function setReferenceFieldValue(fieldContainer,params){var sourceField=fieldContainer.find("input.sourceField").attr("name");fieldContainer.find("input[name=\""+sourceField+"\"]").val(params.id),fieldContainer.find("input[data-display=\"".concat(sourceField,"\"]")).val(params.name);}/**
	 * Register fields validations .
	 */},{key:"registerFieldsValidations",value:function registerFieldsValidations(){this.form.validationEngine(app.validationEngineOptions);}/**
	 * Register tree.
	 */},{key:"registerTree",value:function registerTree(){this.form.find(".js-tree-select").on("click",function(e){var containerField=$(e.currentTarget).closest(".js-tree-content"),treeValueField=containerField.find(".js-tree-value"),fieldDisplayElement=containerField.find("input[data-display=\"".concat(treeValueField.attr("name"),"\"]")),multiple=treeValueField.data("multiple");app.showModalWindow(containerField.find(".js-tree-modal-window").clone(),function(modalContainer){var jstreeInstance=modalContainer.find(".js-tree-jstree");1===multiple?new window.App.Fields.MultiTree(jstreeInstance):new window.App.Fields.Tree(jstreeInstance),modalContainer.find(".js-tree-modal-select").on("click",function(){var selectedCategories=[];if($.each(jstreeInstance.jstree("get_selected",!0),function(index,value){selectedCategories.push(value);}),0!=selectedCategories.length){var treeText=[],treeValue=[];$.each(selectedCategories,function(index,value){treeValue.push(value.original.tree),treeText.push(value.text);}),fieldDisplayElement.val(treeText.join(",")),fieldDisplayElement.attr("readonly",!0),treeValueField.val(treeValue.join(",")),app.hideModalWindow("",modalContainer.data("modalId")),PNotify.defaultStack.close();}else app.showNotify({text:app.translate("JS_PLEASE_SELECT_ATLEAST_ONE_OPTION"),type:"error"});});});}),this.form.find(".js-tree-clear").on("click",function(e){var containerField=$(e.currentTarget).closest(".js-tree-content"),treeValueField=containerField.find(".js-tree-value"),fieldDisplayElement=containerField.find("input[data-display=\"".concat(treeValueField.attr("name"),"\"]"));fieldDisplayElement.val(""),fieldDisplayElement.attr("readonly",!1),treeValueField.val("");});}/**
	 * Save record
	 */},{key:"save",value:function save(params){if(!this.form.validationEngine("validate"))return void app.formAlignmentAfterValidation(this.form);var callbackBeforeSave=params.callbackBeforeSave||function(){},callbackAfterSave=params.callbackAfterSave||function(){},progress=$.progressIndicator({message:app.translate("JS_SAVE_LOADER_INFO"),position:"html",blockInfo:{enabled:!0}}),beforeSaveResult=callbackBeforeSave(this.form.serializeFormData());if(!1===beforeSaveResult)return void progress.progressIndicator({mode:"hide"});var formData=new FormData(this.form[0]);AppConnector.request({url:"index.php",type:"POST",data:formData,processData:!1,contentType:!1}).done(function(response){progress.progressIndicator({mode:"hide"}),response.success&&app.showNotify({text:app.translate("JS_SAVE_NOTIFY_SUCCESS"),type:"success"}),callbackAfterSave(response.result);}).fail(function(textStatus,errorThrown,jqXHR){progress.progressIndicator({mode:"hide"}),callbackAfterSave(!1),app.showNotify({type:"error",title:app.translate("JS_ERROR"),text:jqXHR.responseJSON.error.message,animation:"show"});});}/**
	 * Register edit view events
	 */},{key:"registerEditViewEvents",value:function registerEditViewEvents(){var _this2=this;this.registerSubmit({callbackAfterSave:function callbackAfterSave(response){response&&(window.location.href="index.php?module="+_this2.moduleName+"&view=DetailView&record="+response.id);}}),this.container.find(".js-edit-back").on("click",function(){window.history.back();});}},{key:"registerSubmit",value:function registerSubmit(params){var _this3=this;this.container.find(".js-edit-view-submit, .js-form-submit").on("click",function(){_this3.save(params);});}/**
	 * Register keyboard shortcuts events
	 */},{key:"registerKeyboardShortcutsEvent",value:function registerKeyboardShortcutsEvent(){var _this4=this;document.addEventListener("keydown",function(event){event.altKey&&"KeyS"===event.code&&_this4.container.find(".js-edit-view-submit, .js-form-submit").trigger("click");});}/**
	 * Register form events.
	 */},{key:"registerFormEvents",value:function registerFormEvents(){this.getContainer(),this.registerReferenceEvent(),this.registerFieldsValidations(),this.registerTree(),this.registerKeyboardShortcutsEvent(),this.form.find(":input").inputmask();}/**
	 * Register edit view events.
	 */},{key:"registerEvents",value:function registerEvents(){this.getContainer(),this.registerFormEvents(),this.registerEditViewEvents();}}],[{key:"getInstanceByModuleName",value:/**
	 * Function to get Instance by name
	 *
	 * @param {string} moduleName Name of the module to create instance
	 *
	 * @returns {Base_EditView_Js}
	 */function getInstanceByModuleName(moduleName){"undefined"==typeof moduleName&&(moduleName=app.getModuleName());var instance,modalClass=moduleName+"_EditView_Js";return "undefined"==typeof window[modalClass]&&(modalClass="Base_EditView_Js"),"undefined"!=typeof window[modalClass]&&(instance=new window[modalClass]),instance.moduleName=moduleName,instance}}]),_class}();
//# sourceMappingURL=EditView.min.js.map
