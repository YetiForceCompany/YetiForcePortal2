'use strict';

/* {[The file is published on the basis of YetiForce Public License 4.0 that can be found in the following directory: licenses/LicenseEN.txt or yetiforce.com]} */'use strict';function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var descriptor,i=0;i<props.length;i++)descriptor=props[i],descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor);}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}var MultiImage=/*#__PURE__*/function(){/**
	 * Create class instance
	 *
	 * @param {HTMLElement|jQuery} inputElement - input type file element inside component
	 */function MultiImage(element){_classCallCheck(this,MultiImage);var thisInstance=this;this.elements={},this.options={showCarousel:!0},this.detailView=!1,this.elements.fileInput=element.find(".js-multi-image__file").eq(0),0===this.elements.fileInput.length&&(this.detailView=!0),this.elements.component=element.eq(0),this.elements.form=element.closest("form").eq(0),this.elements.addButton=this.elements.component.find(".js-multi-image__file-btn").eq(0),this.elements.values=this.elements.component.find(".js-multi-image__values").eq(0),this.elements.progressBar=this.elements.component.find(".js-multi-image__progress-bar").eq(0),this.elements.progress=this.elements.component.find(".js-multi-image__progress").eq(0),this.elements.result=this.elements.component.find(".js-multi-image__result").eq(0),this.fieldInfo=this.elements.values.data("fieldinfo"),this.options.formats=this.fieldInfo.formats,this.options.limit=this.fieldInfo.limit,this.files=this.detailView?this.elements.values.data("value"):JSON.parse(this.elements.values.val()),this.detailView||this.elements.fileInput.fileupload({dataType:"json",replaceFileInput:!1,fileInput:this.fileInput,autoUpload:!1,add:this.add.bind(this),change:this.change.bind(this),fail:this.uploadError.bind(this)}),this.elements.component.on("click",".js-multi-image__popover-img",function(){thisInstance.zoomPreview($(this).data("hash"));}),this.elements.component.on("click",".js-multi-image__popover-btn-zoom",function(e){e.preventDefault(),thisInstance.zoomPreview($(this).data("hash"));}),this.elements.component.on("click",".js-multi-image__popover-btn-download",function(e){e.preventDefault(),thisInstance.download($(this).data("hash"));}),this.detailView||this.elements.component.on("click",".js-multi-image__popover-btn-delete",function(e){e.preventDefault(),thisInstance.deleteFile($(this).data("hash"));}),this.loadExistingFiles();}/**
	 * Prevent form submission
	 *
	 * @param {Event} e
	 */return _createClass(MultiImage,[{key:"addButtonClick",value:function addButtonClick(e){e.preventDefault(),this.elements.fileInput.trigger("click");}/**
	 * Get file information
	 *
	 * @param {String} hash - file id
	 * @returns {Object}
	 */},{key:"getFileInfo",value:function getFileInfo(hash){for(var file,i=0,len=this.files.length;i<len;i++)if(file=this.files[i],file.hash===hash)return file;app.errorLog("File '".concat(hash,"' not found.")),app.showNotify({text:app.translate("JS_INVALID_FILE_HASH")+" [".concat(hash,"]"),type:"error"});}/**
	 * Add property to file info object
	 *
	 * @param {String} hash - file id
	 * @param {String} propertyName
	 * @param {any} value
	 * @returns {Object}
	 */},{key:"addFileInfoProperty",value:function addFileInfoProperty(hash,propertyName,value){var fileInfo=this.getFileInfo(hash);return fileInfo[propertyName]=value,fileInfo}/**
	 * Error event handler from file upload request
	 *
	 * @param {Event} e
	 * @param {Object} data
	 */},{key:"uploadError",value:function uploadError(e,data){var _this=this;app.errorLog("File upload error.");var jqXHR=data.jqXHR,files=data.files;if("undefined"==typeof jqXHR.responseJSON||null===jqXHR.responseJSON)return App.Fields.MultiImage.currentFileUploads--,app.showNotify({text:app.translate("JS_FILE_UPLOAD_ERROR"),type:"error"});var response=jqXHR.responseJSON;// first try to show error for concrete file
return "undefined"!=typeof response.result&&"undefined"!=typeof response.result.attach&&Array.isArray(response.result.attach)?(response.result.attach.forEach(function(fileAttach){App.Fields.MultiImage.currentFileUploads--,_this.deleteFile(fileAttach.hash,!1),"string"==typeof fileAttach.error?app.showNotify({text:fileAttach.error+" [".concat(fileAttach.name,"]"),type:"error"}):app.showNotify({text:app.translate("JS_FILE_UPLOAD_ERROR")+" [".concat(fileAttach.name,"]"),type:"error"});}),void this.updateFormValues()):void(// else show default upload error
files.forEach(function(file){App.Fields.MultiImage.currentFileUploads--,_this.deleteFile(file.hash,!1),app.showNotify({text:app.translate("JS_FILE_UPLOAD_ERROR")+" [".concat(file.name,"]"),type:"error"});}),this.updateFormValues())}/**
	 * Update form input values
	 */},{key:"updateFormValues",value:function updateFormValues(){var formValues=this.files.map(function(file){return {key:file.key,name:file.name,size:file.size}});this.elements.values.val(JSON.stringify(formValues));}/**
	 * Validate file
	 *
	 * @param {Object} file
	 * @returns {boolean}
	 */},{key:"validateFile",value:function validateFile(file){var valid=!1;return this.options.formats.forEach(function(format){file.type==="image/"+format&&(valid=!0);}),valid||app.showNotify({text:"".concat(app.translate("JS_INVALID_FILE_TYPE")," [").concat(file.name,"]\n").concat(app.translate("JS_AVAILABLE_FILE_TYPES"),"  [").concat(this.options.formats.join(", "),"]"),type:"error"}),valid}/**
	 * Show limit error
	 */},{key:"showLimitError",value:function showLimitError(){this.elements.fileInput.val(""),app.showNotify({text:"".concat(app.translate("JS_FILE_LIMIT")," [").concat(this.options.limit,"]"),type:"error"});}/**
	 * Get only valid files from list
	 *
	 * @param {Array} files
	 * @returns {Array}
	 */},{key:"filterValidFiles",value:function filterValidFiles(files){var _this2=this;return files.length+this.files.length>this.options.limit?(this.showLimitError(),[]):files.filter(function(file){return _this2.validateFile(file)})}/**
	 * Set files hash
	 * @param {Array} files
	 * @returns {Array}
	 */},{key:"setFilesHash",value:function setFilesHash(files){for(var file,addedFiles=[],i=0,len=files.length;i<len;i++)if(file=files[i],"undefined"==typeof file.hash)if(this.files.length<this.options.limit)file.hash=this.generateRandomHash(CONFIG.userId),this.files.push({hash:file.hash,imageSrc:file.imageSrc,name:file.name,file:file}),addedFiles.push(file);else return this.showLimitError(),addedFiles;return addedFiles}/**
	 * Add event handler from jQuery-file-upload
	 *
	 * @param {Event} e
	 * @param {object} data
	 */},{key:"add",value:function add(){}/**
	 * Progressall event handler from jQuery-file-upload
	 *
	 * @param {Event} e
	 * @param {Object} data
	 */},{key:"progressAll",value:function progressAll(e,data){var _this3=this,progress=parseInt(100*(data.loaded/data.total),10);this.elements.progressBar.css({width:progress+"%"}),100===progress?setTimeout(function(){_this3.elements.progress.addClass("d-none"),_this3.elements.progressBar.css({width:"0%"});},1e3):this.elements.progress.removeClass("d-none");}/**
	 * Dragover event handler from jQuery-file-upload
	 *
	 * @param {Event} e
	 */},{key:"dragOver",value:function dragOver(){this.elements.component.addClass("c-multi-image__drop-effect");}/**
	 * Dragleave event handler
	 * @param {Event} e
	 */},{key:"dragLeave",value:function dragLeave(){this.elements.component.removeClass("c-multi-image__drop-effect");}/**
	 * Download file according to source type (base64/file from server)
	 *
	 * @param {String} hash
	 */},{key:"download",value:function download(hash){var fileInfo=this.getFileInfo(hash);return "file.php"===fileInfo.imageSrc.substr(0,8).toLowerCase()?this.downloadFile(hash):this.downloadBase64(hash)}/**
	 * Download file that exists on the server already
	 * @param {String} hash
	 */},{key:"downloadFile",value:function downloadFile(hash){var fileInfo=this.getFileInfo(hash),link=document.createElement("a");$(link).css("display","none"),"string"==typeof link.download?(document.body.appendChild(link),link.download=fileInfo.name,link.href=fileInfo.imageSrc,link.click(),document.body.removeChild(link)):location.replace(fileInfo.imageSrc);}/**
	 * Download file from base64 image
	 *
	 * @param {String} hash
	 */},{key:"downloadBase64",value:function downloadBase64(hash){var fileInfo=this.getFileInfo(hash),imageUrl="data:application/octet-stream;filename=".concat(fileInfo.name,";base64,")+fileInfo.imageSrc.split(",")[1],link=document.createElement("a");$(link).css("display","none"),"string"==typeof link.download?(document.body.appendChild(link),link.download=fileInfo.name,link.href=imageUrl,link.click(),document.body.removeChild(link)):location.replace(imageUrl);}/**
	 * Display modal window with large preview
	 *
	 * @param {string} hash
	 */},{key:"zoomPreview",value:function zoomPreview(hash){var _this4=this,thisInstance=this,fileInfo=this.getFileInfo(hash),titleTemplate=function(){return "<i class=\"fa fa-image\"></i> ".concat(fileInfo.name)},bootboxOptions={size:"large",backdrop:!0,onEscape:!0,title:"<span id=\"bootbox-title-".concat(hash,"\">").concat(titleTemplate(),"</span>"),message:"<img src=\"".concat(fileInfo.imageSrc,"\" class=\"w-100\" />"),buttons:{}};this.options.showCarousel&&(bootboxOptions.message=this.generateCarousel(hash)),this.detailView||(bootboxOptions.buttons.Delete={label:"<i class=\"fa fa-trash-alt\"></i> ".concat(app.translate("JS_DELETE")),className:"float-left btn btn-danger",callback:function callback(){thisInstance.deleteFile(fileInfo.hash);}}),bootboxOptions.buttons.Download={label:"<i class=\"fa fa-download\" title=\"".concat(app.translate("JS_DOWNLOAD"),"\"></i>"),className:"float-left btn btn-success",callback:function callback(){thisInstance.download(fileInfo.hash);}},bootboxOptions.buttons.Close={label:"<i class=\"fa fa-times\" title=\"".concat(app.translate("JS_CLOSE"),"\"></i>"),className:"btn btn-warning",callback:function callback(){}},bootbox.dialog(bootboxOptions),this.options.showCarousel&&$("#carousel-".concat(hash)).on("slid.bs.carousel",function(e){fileInfo=_this4.getFileInfo($(e.relatedTarget).data("hash")),$("#bootbox-title-".concat(hash)).html(titleTemplate());});}/**
	 * Remove file from preview and from file list
	 *
	 * @param {String} hash
	 */},{key:"deleteFileCallback",value:function deleteFileCallback(hash){var fileInfo=this.getFileInfo(hash);fileInfo.previewElement&&fileInfo.previewElement.popover("dispose").remove(),this.files=this.files.filter(function(file){return file.hash!==fileInfo.hash}),this.updateFormValues();}/**
	 * Delete image from input field
	 * Should be called with this pointing on button element with data-hash attribute
	 *
	 * @param {string} hash
	 * @param {boolean} showConfirmation - dialog?
	 */},{key:"deleteFile",value:function deleteFile(hash){var _this5=this,showConfirmation=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];if(showConfirmation){var fileInfo=this.getFileInfo(hash);bootbox.confirm({title:"<i class=\"fa fa-trash-alt\"></i> ".concat(app.translate("JS_DELETE_FILE")),message:"".concat(app.translate("JS_DELETE_FILE_CONFIRMATION")," <span class=\"font-weight-bold\">").concat(fileInfo.name,"</span>"),callback:function callback(result){result&&_this5.deleteFileCallback(hash);}});}else this.deleteFileCallback(hash);}/**
	 * File change event handler from jQuery-file-upload
	 *
	 * @param {Event} e
	 * @param {object} data
	 */},{key:"change",value:function change(e,data){var _this6=this;this.clearFilesInput(),data.files=this.filterValidFiles(data.files),data.files=this.setFilesHash(data.files),data.files.length&&this.generatePreviewElements(data.files,function(){_this6.redraw();});}},{key:"clearFilesInput",value:function clearFilesInput(){var _this7=this;this.files.forEach(function(file){file.file&&_this7.deleteFile(file.hash,!1);});}/**
	 * Generate and apply popover to preview
	 *
	 * @param {File} file
	 * @param {string} template
	 * @param {string} imageSrc
	 * @returns {jQuery}
	 */},{key:"addPreviewPopover",value:function addPreviewPopover(file,template,imageSrc){var thisInstance=this,fileSize="",fileInfo=this.getFileInfo(file.hash);"undefined"!=typeof fileInfo.size&&(fileSize="<div class=\"p-1 ml-1 bg-white border rounded small position-absolute\">".concat(fileInfo.size,"</div>"));var deleteBtn="";return this.detailView||(deleteBtn="<button class=\"btn btn-sm btn-danger c-btn-collapsible js-multi-image__popover-btn-delete mb-1\" type=\"button\" data-hash=\"".concat(file.hash,"\" data-js=\"click\" title=\"").concat(app.translate("JS_DELETE"),"\"><i class=\"fa fa-trash-alt\"></i></button>")),$(template).popover({container:thisInstance.elements.component,title:"<div class=\"u-text-ellipsis\"><i class=\"fa fa-image\"></i> ".concat(file.name,"</div>"),html:!0,sanitize:!1,trigger:"focus",placement:"top",content:"<img src=\"".concat(imageSrc,"\" class=\"w-100 js-multi-image__popover-img c-multi-image__popover-img\" data-hash=\"").concat(file.hash,"\" data-js=\"click\"/>"),template:"<div class=\"popover\" role=\"tooltip\">\n\t\t\t\t<div class=\"arrow\"></div>\n\t\t\t\t<h3 class=\"popover-header\"></h3>\n\t\t\t\t<div class=\"popover-body\"></div>\n\t\t\t\t<div class=\"text-right popover-footer js-multi-image__popover-actions\">\n\t\t\t\t\t".concat(fileSize,"\n\t\t\t\t\t").concat(deleteBtn,"\n\t\t\t\t\t<button class=\"btn btn-sm btn-success js-multi-image__popover-btn-download mb-1\" type=\"button\" data-hash=\"").concat(file.hash,"\" data-js=\"click\"><i class=\"fa fa-download\" title=\"").concat(app.translate("JS_DOWNLOAD"),"\"></i> <span class=\"c-btn-collapsible__text\"></span></button>\n\t\t\t\t\t<button class=\"btn btn-sm btn-primary js-multi-image__popover-btn-zoom mb-1 mr-1\" type=\"button\" data-hash=\"").concat(file.hash,"\" data-js=\"click\"><i class=\"fa fa-search-plus\" title=\"").concat(app.translate("JS_ZOOM_IN"),"\"></i> <span class=\"c-btn-collapsible__text\"></span></button>\n\t\t\t\t</div>\n\t\t\t</div>")})}/**
	 * Remove preview popover
	 *
	 * @param {String} hash
	 */},{key:"removePreviewPopover",value:function removePreviewPopover(hash){var fileInfo=this.getFileInfo(hash);"undefined"!=typeof fileInfo.previewElement&&fileInfo.previewElement.popover("dispose");}/**
	 * Hide popovers when user starts moving file preview
	 *
	 * @param {Event} e
	 * @param {Object} ui
	 */},{key:"sortOver",value:function sortOver(){this.elements.result.find(".js-multi-image__preview").popover("hide");}/**
	 * Update file position according to elements order
	 *
	 * @param {Event} e
	 * @param {Object} ui
	 */},{key:"sortStop",value:function sortStop(){var _this8=this,actualElements=this.elements.result.find(".js-multi-image__preview").toArray();this.files=actualElements.map(function(element){for(var elementHash,i=0,len=_this8.files.length;i<len;i++)if(elementHash=$(element).data("hash"),_this8.files[i].hash===elementHash)return _this8.files[i]}),this.redraw();}/**
	 * Redraw view according to in-memory positions
	 */},{key:"redraw",value:function redraw(){var _this9=this;this.files.forEach(function(file){_this9.elements.result.append(file.previewElement);}),this.updateFormValues();}/**
	 * Enable drag and drop files repositioning
	 */},{key:"enableDragNDrop",value:function enableDragNDrop(){this.elements.result.sortable({handle:".js-multi-image__preview-img",items:".js-multi-image__preview",over:this.sortOver.bind(this),stop:this.sortStop.bind(this)}).disableSelection().on("mousedown",".js-multi-image__preview-img",function(){this.focus();});}},{key:"generatePreviewElements",value:function generatePreviewElements(files,callback){var _this10=this;files.forEach(function(file){if(file instanceof File){var template=$(_this10.generatePreviewFromFile(file));file.preview=template,_this10.addFileInfoProperty(file.hash,"previewElement",file.preview),callback(template);}else _this10.generatePreviewFromValue(file,function(template,imageSrc){file.preview=_this10.addPreviewPopover(file,template,imageSrc),_this10.addFileInfoProperty(file.hash,"previewElement",file.preview),callback(file.preview);});});}/**
	 * Generate preview of image as html string
	 *
	 * @param {File} file
	 * @param {function} callback
	 */},{key:"generatePreviewFromFile",value:function generatePreviewFromFile(file){return "<div class=\"mr-1 js-multi-image__preview d-none\" id=\"js-multi-image__preview-hash-".concat(file.hash,"\" data-hash=\"").concat(file.hash,"\" data-js=\"container|click\">\n\t\t\t<button class=\"btn btn-sm btn-danger c-btn-collapsible js-multi-image__popover-btn-delete mr-1\" type=\"button\" data-hash=\"").concat(file.hash,"\" data-js=\"click\" title=\"").concat(app.translate("JS_DELETE"),"\"><i class=\"fa fa-trash-alt\"></i></button>").concat(file.name,"\n\t\t</div>")}/**
	 * Generate preview of image as html string from existing values
	 *
	 * @param {File} file
	 * @param {function} callback
	 */},{key:"generatePreviewFromValue",value:function generatePreviewFromValue(file,callback){callback("<div class=\"d-inline-block mr-1 js-multi-image__preview\" id=\"js-multi-image__preview-hash-".concat(file.hash,"\" data-hash=\"").concat(file.hash,"\" data-js=\"container|click\">\n\t\t\t\t<div class=\"img-thumbnail js-multi-image__preview-img c-multi-image__preview-img\" data-hash=\"").concat(file.hash,"\" data-js=\"drag\" style=\"background-image:url(").concat(file.imageSrc,")\" tabindex=\"0\" title=\"").concat(file.name,"\"></div>\n\t\t</div>"),file.imageSrc);}/**
	 * Load files that were in valueInput as json string
	 */},{key:"loadExistingFiles",value:function loadExistingFiles(){var _this11=this;this.files=this.files.map(function(file){return file.hash=_this11.generateRandomHash(CONFIG.userId),file}).slice(0,this.options.limit),this.generatePreviewElements(this.files,function(element){_this11.elements.result.append(element);}),this.updateFormValues();}/**
	 * Generate carousel for all files in large preview
	 *
	 * @param {String} hash
	 */},{key:"generateCarousel",value:function generateCarousel(hash){if(1>=this.files.length){var fileInfo=this.getFileInfo(hash);return "<img class=\"d-block w-100\" src=\"".concat(fileInfo.imageSrc,"\">")}var template="<div id=\"carousel-".concat(hash,"\" class=\"carousel slide c-carousel\" data-ride=\"carousel\" data-js=\"container\">\n\t\t  <div class=\"carousel-inner\">");return this.files.forEach(function(file){template+="<div class=\"carousel-item c-carousel__item",file.hash===hash&&(template+=" active"),template+="\" data-hash=\"".concat(file.hash,"\">\n\t\t      <img class=\"d-block w-100 c-carousel__image\" src=\"").concat(file.imageSrc,"\">\n\t\t    </div>");}),template+="<a class=\"carousel-control-prev c-carousel__prevnext-btn c-carousel__prev-btn\" href=\"#carousel-".concat(hash,"\" role=\"button\" data-slide=\"prev\" data-js=\"click\">\n\t\t    <span class=\"fas fa-caret-left fa-2x c-carousel__prev-icon mr-1\" aria-hidden=\"true\"></span>\n\t\t  </a>\n\t\t  <a class=\"carousel-control-next c-carousel__prevnext-btn c-carousel__next-btn\" href=\"#carousel-").concat(hash,"\" role=\"button\" data-slide=\"next\" data-js=\"click\">\n\t\t    <span class=\"fas fa-caret-right fa-2x c-carousel__next-icon ml-1\" aria-hidden=\"true\"></span>\n\t\t  </a>\n\t\t</div>"),template}/**
	 * generate random hash
	 * @returns {string}
	 */},{key:"generateRandomHash",value:function generateRandomHash(){var prefix=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";prefix=prefix.toString();var hash=Math.random().toString(36).substr(2,10)+Math.random().toString(36).substr(2,10)+new Date().valueOf()+Math.random().toString(36).substr(2,6);return prefix?prefix+hash:hash}}]),MultiImage}();
//# sourceMappingURL=MultiImage.min.js.map
